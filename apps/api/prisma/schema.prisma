generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MANAGER
  BDC
  SALES
}

enum DealershipStatus {
  ACTIVE
  INACTIVE
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  APPOINTMENT_SET
  NEGOTIATING
  SOLD
  LOST
}

enum LeadType {
  NEW_VEHICLE
  USED_VEHICLE
  SERVICE
  FINANCE
  GENERAL
  TRADE_IN
}

enum ActivityType {
  CALL
  EMAIL
  SMS
  NOTE
  VISIT
  TEST_DRIVE
  OTHER
}

enum MessageChannel {
  SMS
  EMAIL
  CALL
  NOTE
}

enum MessageDirection {
  OUTBOUND
  INBOUND
}

enum MessageStatus {
  QUEUED
  SENT
  DELIVERED
  FAILED
  RECEIVED
}

enum TaskStatus {
  OPEN
  DONE
  SNOOZED
  CANCELED
}

enum AppointmentStatus {
  SET
  CONFIRMED
  SHOWED
  NO_SHOW
  CANCELED
}

enum IntegrationProvider {
  GENERIC
  AUTOTRADER
  CARGURUS
  OEM_FORM
  REFERRAL
}


enum AiFeature {
  lead_summary
  lead_score
  draft_followup
  next_best_action
}

model DealerGroup {
  id          String       @id @default(cuid())
  name        String       @unique
  dealerships Dealership[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("AutoGroup")
}

model Dealership {
  id          String               @id @default(cuid())
  dealerGroupId String             @map("autoGroupId")
  name        String
  slug        String               @unique
  timezone    String               @default("UTC")
  status      DealershipStatus     @default(ACTIVE)
  businessHours Json?
  dealerGroup DealerGroup          @relation(fields: [dealerGroupId], references: [id])
  leads       Lead[]
  tasks       Task[]
  messages Message[]
  appointments Appointment[]
  integrations Integration[]
  integrationEvents IntegrationEvent[]
  eventLogs    EventLog[]
  aiRequestLogs AIRequestLog[]
  auditLogs    AuditLog[]
  users       UserDealershipRole[]
  invitations Invitation[]
  conversationThreads ConversationThread[]
  communicationTemplates CommunicationTemplate[]
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  twilioAccountSid         String?
  twilioAuthToken          String?
  twilioMessagingServiceSid String?
  twilioFromPhone          String?

}

model AuditLog {
  id           String    @id @default(cuid())
  dealershipId String
  userId       String?
  action       String
  entityType   String
  entityId     String?
  metadata     Json?
  createdAt    DateTime  @default(now())
  dealership   Dealership @relation(fields: [dealershipId], references: [id])
  user         User?      @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([dealershipId, createdAt])
  @@index([dealershipId, action])
  @@index([userId])
}

model User {
  id               String               @id @default(cuid())
  email            String               @unique
  passwordHash     String
  refreshTokenHash String?
  isPlatformAdmin  Boolean              @default(false)
  isPlatformOperator Boolean             @default(false)
  firstName        String
  lastName         String
  phone            String?
  dealerships      UserDealershipRole[]
  createdInvitations Invitation[]       @relation("InvitationCreatedBy")
  assignedLeads    Lead[]               @relation("LeadAssignments")
  soldLeads        Lead[]               @relation("LeadSoldBy")
  assignedTasks    Task[]               @relation("TaskAssignments")
  activities       Activity[]
  auditLogs        AuditLog[]
  eventLogs        EventLog[]
  sentMessages     Message[]       @relation("MessageActorUser")
  createdCommunicationTemplates CommunicationTemplate[] @relation("CommunicationTemplateCreatedBy")
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
}

model EventLog {
  id           String     @id @default(cuid())
  dealershipId String
  actorUserId  String?
  entityType   String
  entityId     String
  eventType    String
  payload      Json?
  occurredAt   DateTime   @default(now())
  dealership   Dealership @relation(fields: [dealershipId], references: [id])
  actorUser    User?      @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([dealershipId, occurredAt])
  @@index([eventType])
}

model UserDealershipRole {
  id           String     @id @default(cuid())
  userId       String
  dealershipId String
  role         Role
  isActive     Boolean    @default(true)
  user         User       @relation(fields: [userId], references: [id])
  dealership   Dealership @relation(fields: [dealershipId], references: [id])
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([userId, dealershipId])
  @@index([dealershipId])
}

model Invitation {
  id           String           @id @default(cuid())
  token        String           @unique
  email        String
  dealershipId String
  role         Role
  expiresAt    DateTime
  createdBy    String
  status       InvitationStatus @default(PENDING)
  acceptedAt   DateTime?
  dealership   Dealership       @relation(fields: [dealershipId], references: [id])
  createdByUser User            @relation("InvitationCreatedBy", fields: [createdBy], references: [id])
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@index([dealershipId, status])
  @@index([email, status])
}

model LeadSource {
  id          String   @id @default(cuid())
  dealershipId String
  name        String
  leads       Lead[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([dealershipId])
  @@unique([dealershipId, name])
}

model Lead {
  id                String     @id @default(cuid())
  dealershipId      String
  sourceId          String?
  source            LeadSource? @relation(fields: [sourceId], references: [id])
  status            LeadStatus @default(NEW)
  leadType          LeadType   @default(GENERAL)
  assignedToUserId  String?
  assignedToUser    User?      @relation("LeadAssignments", fields: [assignedToUserId], references: [id])
  soldAt            DateTime?
  soldByUserId      String?
  soldByUser        User?      @relation("LeadSoldBy", fields: [soldByUserId], references: [id], onDelete: SetNull)
  leadScore         Int?
  firstName         String?
  lastName          String?
  email             String?
  phone             String?
  vehicleInterest   String?
  lastActivityAt    DateTime?
  dealership        Dealership @relation(fields: [dealershipId], references: [id])
  activities        Activity[]
  tasks             Task[]
  appointments      Appointment[]
  integrationEvents IntegrationEvent[]
  aiRequestLogs AIRequestLog[]
  conversationThreads ConversationThread[]
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  @@index([dealershipId])
  @@index([dealershipId, status])
  @@index([dealershipId, assignedToUserId])
  @@index([dealershipId, sourceId])
  @@index([dealershipId, lastActivityAt])
  @@index([dealershipId, leadType])
}

model ConversationThread {
  id           String    @id @default(cuid())
  dealershipId String
  leadId       String
  dealership   Dealership @relation(fields: [dealershipId], references: [id])
  lead         Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  messages     Message[]
  createdAt    DateTime  @default(now())

  @@unique([dealershipId, leadId])
  @@index([dealershipId, createdAt])
  @@index([leadId, createdAt])
}

model Message {
  id                String              @id @default(cuid())
  dealershipId      String
  threadId          String
  channel           MessageChannel
  direction         MessageDirection
  body              String
  status            MessageStatus
  sentAt            DateTime?
  actorUserId       String?
  provider          String?
  providerMessageId String?
  errorCode         String?
  errorMessage      String?
  toPhone           String?
  fromPhone         String?
  callDurationSec   Int?
  callOutcome       String?

  dealership        Dealership          @relation(fields: [dealershipId], references: [id])
  thread            ConversationThread  @relation(fields: [threadId], references: [id], onDelete: Cascade)
  actorUser         User?               @relation("MessageActorUser", fields: [actorUserId], references: [id], onDelete: SetNull)

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@index([dealershipId, createdAt])
  @@index([threadId, createdAt])
}


model CommunicationTemplate {
  id           String          @id @default(cuid())
  dealershipId String
  channel      MessageChannel
  name         String
  subject      String?
  body         String
  isActive     Boolean         @default(true)
  createdBy    String
  dealership   Dealership      @relation(fields: [dealershipId], references: [id])
  createdByUser User           @relation("CommunicationTemplateCreatedBy", fields: [createdBy], references: [id])
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@index([dealershipId, channel])
  @@unique([dealershipId, channel, name])
}

model Integration {
  id            String              @id @default(cuid())
  dealershipId  String
  name          String
  provider      IntegrationProvider
  webhookSecret String
  config        Json?
  isActive      Boolean             @default(true)
  dealership    Dealership          @relation(fields: [dealershipId], references: [id])
  events        IntegrationEvent[]
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@unique([dealershipId, name])
  @@index([dealershipId])
  @@index([dealershipId, provider])
}

model IntegrationEvent {
  id            String              @id @default(cuid())
  dealershipId  String
  integrationId String?
  provider      IntegrationProvider
  rawPayload    Json
  parsedPayload Json?
  parsedOk      Boolean             @default(false)
  error         String?
  leadId        String?
  receivedAt    DateTime            @default(now())
  dealership    Dealership          @relation(fields: [dealershipId], references: [id])
  integration   Integration?        @relation(fields: [integrationId], references: [id], onDelete: SetNull)
  lead          Lead?               @relation(fields: [leadId], references: [id], onDelete: SetNull)

  @@index([dealershipId, receivedAt])
  @@index([dealershipId, provider])
  @@index([integrationId])
  @@index([leadId])
}

model Appointment {
  id           String            @id @default(cuid())
  dealershipId String
  status       AppointmentStatus @default(SET)
  start_at     DateTime
  end_at       DateTime
  lead_id      String?
  note         String?
  dealership   Dealership        @relation(fields: [dealershipId], references: [id])
  lead         Lead?             @relation(fields: [lead_id], references: [id], onDelete: SetNull)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  @@index([dealershipId])
  @@index([dealershipId, status])
  @@index([dealershipId, start_at])
  @@index([dealershipId, lead_id])
}

model Task {
  id               String     @id @default(cuid())
  dealershipId     String
  title            String
  description      String?
  status           TaskStatus @default(OPEN)
  dueAt            DateTime?
  assignedToUserId String?
  leadId           String?
  dealership       Dealership @relation(fields: [dealershipId], references: [id])
  assignedToUser   User?      @relation("TaskAssignments", fields: [assignedToUserId], references: [id])
  lead             Lead?      @relation(fields: [leadId], references: [id], onDelete: SetNull)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  @@index([dealershipId])
  @@index([dealershipId, status])
  @@index([dealershipId, assignedToUserId])
  @@index([dealershipId, leadId])
  @@index([dealershipId, dueAt])
}

model Activity {
  id              String       @id @default(cuid())
  type            ActivityType
  subject         String
  body            String?
  outcome         String?
  createdByUserId String
  leadId          String
  createdByUser   User         @relation(fields: [createdByUserId], references: [id])
  lead            Lead         @relation(fields: [leadId], references: [id], onDelete: Cascade)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([leadId, createdAt])
  @@index([createdByUserId])
}


model AIRequestLog {
  id             String    @id @default(cuid())
  dealershipId   String
  leadId         String
  feature        AiFeature
  requestPayload Json
  resultPayload  Json
  createdAt      DateTime  @default(now())
  dealership     Dealership @relation(fields: [dealershipId], references: [id])
  lead           Lead       @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([dealershipId, leadId, createdAt])
  @@index([dealershipId, feature])
}
